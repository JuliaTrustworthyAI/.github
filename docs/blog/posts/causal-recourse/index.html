<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jorge Luiz Franco">
<meta name="dcterms.date" content="2024-09-17">
<meta name="description" content="This post introduces a new tool in CounterfactualExplanations.jl, enhancing the package with causal reasoning to generate counterfactual explanations.">

<title>When Causality meets Recourse – Taija</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../www/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../www/logo_close.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Taija</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../content/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JuliaTrustworthyAI"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#project-overview" id="toc-project-overview" class="nav-link" data-scroll-target="#project-overview">Project Overview</a>
  <ul class="collapse">
  <li><a href="#key-contributions" id="toc-key-contributions" class="nav-link" data-scroll-target="#key-contributions">Key Contributions</a></li>
  <li><a href="#the-mintgenerator" id="toc-the-mintgenerator" class="nav-link" data-scroll-target="#the-mintgenerator">The <code>MINTGenerator</code></a></li>
  <li><a href="#description" id="toc-description" class="nav-link" data-scroll-target="#description">Description</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a>
  <ul class="collapse">
  <li><a href="#causalinference.jl" id="toc-causalinference.jl" class="nav-link" data-scroll-target="#causalinference.jl"><code>CausalInference.jl</code></a></li>
  <li><a href="#counterfactualexplanations.jl" id="toc-counterfactualexplanations.jl" class="nav-link" data-scroll-target="#counterfactualexplanations.jl"><code>CounterfactualExplanations.jl</code></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/JuliaTrustworthyAI/.github/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">When Causality meets Recourse</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Counterfactual Explanations through Structural Causal Models</p>
  <div class="quarto-categories">
    <div class="quarto-category">counterfactuals</div>
    <div class="quarto-category">explainable AI</div>
    <div class="quarto-category">causality</div>
    <div class="quarto-category">Julia</div>
  </div>
  </div>

<div>
  <div class="description">
    <p>This post introduces a new tool in CounterfactualExplanations.jl, enhancing the package with causal reasoning to generate counterfactual explanations.</p>
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><a href="https://www.linkedin.com/in/jorgelwyz/">Jorge Luiz Franco</a> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 17, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In recent years, the need for interpretable and explainable AI has surged, particularly in high-stakes domains. Counterfactual explanations provide a means to understand how changes to input features could alter the outcomes of machine learning models. This blog post presents a new tool in the CounterfactualExplanations.jl package, developed during my JSoC (Julia Summer of Code) project, which incorporates causal reasoning into counterfactual generation.</p>
</section>
<section id="project-overview" class="level1">
<h1>Project Overview</h1>
<p>This project aimed to enhance the CounterfactualExplanations.jl package by infusing it with a robust mathematical foundation for minimal algorithmic recourse, based on the principles of causal reasoning <span class="citation" data-cites="karimi2021algorithmic">(<a href="#ref-karimi2021algorithmic" role="doc-biblioref">Karimi, Schölkopf, and Valera 2021</a>)</span>.</p>
<section id="key-contributions" class="level2">
<h2 class="anchored" data-anchor-id="key-contributions">Key Contributions</h2>
<p>During the project, I contributed to two key repositories:</p>
<ol type="1">
<li><p><strong>CounterfactualExplanations.jl</strong>: Developed a new tool for generating counterfactual explanations using causal information. This allows users to create smarter perturbations rather than random adjustments, ultimately providing more meaningful insights.</p></li>
<li><p><strong>CausalInference.jl</strong>: Implemented a Structural Causal Model (SCM) structure that extracts information from data, laying the groundwork for the causal reasoning capabilities in CounterfactualExplanations.jl.</p></li>
</ol>
<p>This was an amazing experience, not just experience contribute to two repositories simultaneously, but also to work with the mantainers of these repos. I learned a lot about the Julia language and the Julia community. This was possible because of the mentorship of Patrick Altmeyer (CounterfactualExplanations) and Moritz Schauer (CausalInference), who guided me throughout the project and are amazing researchers.</p>
</section>
<section id="the-mintgenerator" class="level2">
<h2 class="anchored" data-anchor-id="the-mintgenerator">The <code>MINTGenerator</code></h2>
<p>In this project, we developed the MINTGenerator, a counterfactual generator based on the Recourse through Minimal Intervention (MINT) method proposed by <span class="citation" data-cites="karimi2021algorithmic">Karimi, Schölkopf, and Valera (<a href="#ref-karimi2021algorithmic" role="doc-biblioref">2021</a>)</span>.</p>
</section>
<section id="description" class="level2">
<h2 class="anchored" data-anchor-id="description">Description</h2>
<p>The MINTGenerator incorporates causal reeasoning in algorithm recourse to achieve minimal interventions when generating a counterfactual explanation. In this sense, the main ideia is that just perturbating a black box model without taking into account the causal relations in the data can guide to misleading recommendations. Here we now shift to a perspective where every action/pertubation is an intervetion in the causal graph of the problem, thus the change is not made just in the intervened upon variable, but also in its childs in the causal structure. The generator utilizes a Structural Causal Model(SCM) to encode the variables in a way that causal effects are propagated and uses a generic gradient-based generator to create the search path, that is, any gradient-base generator (ECCo, REVISE, Watcher, …) can be used with the MINT SCM encoder to generate counterfactual samples in latent space for minimal intervetions algorithm recourse.</p>
<p>The MINT algorithm minimizes a loss function that combines the causal constraints of the SCM and the distance between the generated counterfactual and the original input. Since we want a gradient-based generator, we need to pass the constrained optimizaiton problem into an unconstrained one and we do this by using the Lagrangian. Initially, as defined in <span class="citation" data-cites="karimi2021algorithmic">(<a href="#ref-karimi2021algorithmic" role="doc-biblioref">Karimi, Schölkopf, and Valera 2021</a>)</span>, we aim to aim to find the minimal cost set of actions <span class="math inline">\(A\)</span> (in the form of structural interventions) that results in a counterfactual instance yielding the favorable output from <span class="math inline">\(h\)</span>,</p>
$$
<span class="math display">\[\begin{aligned}

A^* \in \arg\min_A \text{cost}(A; \mathbf{x}_F)\\
\textrm{s.t.} \quad  h(\mathbf{x}_{SCF}) \neq h(\mathbf{x}_F) \; \; \text{,}\\

\end{aligned}\]</span>
<p>$$</p>
<p>where <span class="math inline">\(\mathbf{x}_F\)</span> is the original input, <span class="math inline">\(\mathbf{x}_{SCF}\)</span> is the counterfactual instance, and <span class="math inline">\(h\)</span> is the black-box model. We use the <span class="math inline">\(\mathbf{x}_{SCF}\)</span> terminology because the counterfactual is derived from the SCM,</p>
<p><span class="math display">\[
x_{SCF_i} =
\begin{cases}
x_{F_i} + \delta_i, &amp; \text{if } i \in I \\
x_{F_i} + f_i(\text{pa}_{SCF_i}) - f_i(\text{pa}_{F_i}), &amp; \text{if } i \notin I  \; \; \text{,}
\end{cases}
\]</span></p>
<p>where <span class="math inline">\(I\)</span> is the set of intervened upon variables, <span class="math inline">\(f_i\)</span> is the function that generates the value of the variable <span class="math inline">\(i\)</span> given its parents, and <span class="math inline">\(\text{pa}_{SCF_i}\)</span> and <span class="math inline">\(\text{pa}_{F_i}\)</span> are the parents of the variable <span class="math inline">\(i\)</span> in the counterfactual and original instance, respectively. This closed formula for the decision variable <span class="math inline">\(\mathbf{x}_{SCF}\)</span> is what makes possible to use a gradient-based generator, since with it the lagrangian is differentiable,</p>
<p><span class="math display">\[
\mathcal{L}(A ; \lambda) = \text{cost}(A; \mathbf{x}_F) + \lambda \left(h(\mathbf{x}_{SCF}) - h(\mathbf{x}_F) \right) \; \; \text{,}
\]</span></p>
<p>or in simple terms and more standard, since <span class="math inline">\(\lambda\)</span> is constant,</p>
<p><span class="math display">\[
\mathcal{L_{\texttt{MINT}}}(\mathbf{x}_{SCF}) = \lambda \text{cost}(\mathbf{x}_{SCF}; \mathbf{x}_F) + \text{yloss}(\mathbf{x}_{SCF},y^*) \; \; \text{,}
\]</span></p>
<p>where <span class="math inline">\(y^*\)</span> is clearly <span class="math inline">\(h(x_F)\)</span> and <span class="math inline">\(\text{yloss}\)</span> is :</p>
<p><span class="math display">\[
\text{yloss}(\mathbf{x}_{SCF}, y^*) = h \left(\left\{ x_{F_i} + \delta_i [i \in I] + \left(f_i(\text{pa}_{SCF_i}) - f_i(\text{pa}_{F_i}) \right) [i \notin I] \right\}_{i=1}^n \right) - y^* \; \; \text{.}
\]</span></p>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<section id="causalinference.jl" class="level3">
<h3 class="anchored" data-anchor-id="causalinference.jl"><code>CausalInference.jl</code></h3>
<p>In terms of implementation, we need to capture the causal relations from the data, that’s where <code>CausalInference.jl</code> comes in. However, before the project, the package did not have a SCM structure, in the sense that the methods just captured the topological Directed Acyclic Graph (DAG) that showed the causality ruling the data, that is, no causal structural equations were provided,</p>
<div id="2" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">using</span> <span class="bu">CausalInference</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">using</span> <span class="bu">Plots</span>, <span class="bu">GraphRecipes</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">using</span> <span class="bu">Random</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(<span class="fl">1</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a>N <span class="op">=</span> <span class="fl">2000</span> <span class="co"># number of data points</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>x <span class="op">=</span> <span class="fu">randn</span>(N)</span>
<span id="cb1-9"><a href="#cb1-9"></a>v <span class="op">=</span> x <span class="op">+</span> <span class="fu">randn</span>(N)<span class="op">*</span><span class="fl">0.25</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>w <span class="op">=</span> x <span class="op">+</span> <span class="fu">randn</span>(N)<span class="op">*</span><span class="fl">0.25</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>z <span class="op">=</span> v <span class="op">+</span> w <span class="op">+</span> <span class="fu">randn</span>(N)<span class="op">*</span><span class="fl">0.25</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>s <span class="op">=</span> z <span class="op">+</span> <span class="fu">randn</span>(N)<span class="op">*</span><span class="fl">0.25</span></span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a>df <span class="op">=</span> (x<span class="op">=</span>x, v<span class="op">=</span>v, w<span class="op">=</span>w, z<span class="op">=</span>z, s<span class="op">=</span>s)</span>
<span id="cb1-15"><a href="#cb1-15"></a></span>
<span id="cb1-16"><a href="#cb1-16"></a>est_g, score <span class="op">=</span> <span class="fu">ges</span>(df; penalty<span class="op">=</span><span class="fl">1.0</span>, parallel<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a>plt <span class="op">=</span> <span class="fu">graphplot</span>(<span class="fu">pdag2dag!</span>(est_g), names<span class="op">=</span> [<span class="fu">String</span>(k) for k <span class="kw">in</span> <span class="fu">keys</span>(df)], size<span class="op">=</span>(<span class="fl">500</span>,<span class="fl">500</span>), nodesize<span class="op">=</span><span class="fl">0.1</span>, fontsize<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="fu">savefig</span>(plt, <span class="st">"www/intro.png"</span>)</span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="fu">display</span>(plt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>┌ Warning: Only one thread available
└ @ CausalInference ~/.julia/packages/CausalInference/ozcj8/src/ges.jl:52</code></pre>
</div>
<div class="cell-output cell-output-display">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="500" height="500" viewbox="0 0 2000 2000">
<defs>
  <clippath id="clip350">
    <rect x="0" y="0" width="2000" height="2000"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip350)" d="M0 2000 L2000 2000 L2000 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip351">
    <rect x="400" y="199" width="1401" height="1401"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip350)" d="M47.2441 1952.76 L1952.76 1952.76 L1952.76 47.2441 L47.2441 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip352">
    <rect x="47" y="47" width="1907" height="1907"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="319.46,567.322 333.675,566.069 347.883,564.804 362.079,563.515 376.257,562.189 390.411,560.813 404.535,559.376 418.622,557.866 432.667,556.269 446.664,554.573 460.606,552.767 474.488,550.838 488.303,548.773 502.046,546.561 515.71,544.189 529.289,541.644 542.777,538.915 556.169,535.989 569.458,532.854 582.638,529.498 595.703,525.907 608.647,522.071 621.464,517.976 634.148,513.61 646.693,508.961 659.093,504.018 671.348,498.78 683.464,493.258 695.446,487.466 707.302,481.416 719.037,475.119 730.656,468.589 742.167,461.837 753.575,454.876 764.887,447.718 776.107,440.376 787.243,432.861 798.3,425.186 809.285,417.364 820.203,409.406 831.06,401.325 841.863,393.134 852.618,384.844 863.33,376.468 874.006,368.018 884.652,359.506 895.274,350.946 905.877,342.348 916.468,333.726 927.054,325.091 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="894.326,332.431 927.054,325.091 913.288,355.677 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="927.054,325.091 916.468,333.726 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="527.079,1488.89 526.865,1469.06 526.638,1449.24 526.384,1429.43 526.091,1409.62 525.745,1389.84 525.333,1370.07 524.843,1350.33 524.261,1330.62 523.573,1310.94 522.767,1291.3 521.83,1271.7 520.748,1252.14 519.508,1232.63 518.097,1213.18 516.503,1193.78 514.711,1174.45 512.709,1155.18 510.483,1135.98 508.02,1116.85 505.308,1097.8 502.333,1078.83 499.082,1059.95 495.541,1041.16 491.699,1022.46 487.541,1003.86 483.068,985.36 478.293,966.952 473.229,948.634 467.888,930.403 462.285,912.253 456.432,894.18 450.342,876.182 444.029,858.253 437.505,840.389 430.784,822.587 423.879,804.842 416.803,787.15 409.57,769.507 402.191,751.909 394.682,734.352 387.054,716.832 379.321,699.345 371.495,681.886 363.591,664.452 355.622,647.038 347.599,629.641 339.537,612.256 331.449,594.879 323.348,577.506 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="322.432,611.034 323.348,577.506 349.621,598.356 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="323.348,577.506 331.449,594.879 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="527.079,1488.89 541.317,1487.67 555.549,1486.44 569.769,1485.18 583.971,1483.89 598.148,1482.55 612.296,1481.14 626.408,1479.66 640.477,1478.1 654.499,1476.43 668.466,1474.66 682.373,1472.76 696.214,1470.73 709.983,1468.55 723.673,1466.21 737.28,1463.69 750.796,1461 764.216,1458.1 777.533,1455 790.743,1451.67 803.838,1448.11 816.813,1444.3 829.662,1440.23 842.378,1435.9 854.956,1431.28 867.39,1426.36 879.68,1421.15 891.831,1415.65 903.85,1409.89 915.743,1403.86 927.516,1397.59 939.174,1391.09 950.724,1384.36 962.172,1377.42 973.523,1370.29 984.785,1362.97 995.962,1355.48 1007.06,1347.83 1018.09,1340.03 1029.05,1332.1 1039.95,1324.04 1050.8,1315.87 1061.59,1307.6 1072.35,1299.25 1083.07,1290.82 1093.76,1282.33 1104.43,1273.8 1115.07,1265.22 1125.71,1256.62 1136.34,1248.01 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1103.59,1255.24 1136.34,1248.01 1122.47,1278.55 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1136.34,1248.01 1125.71,1256.62 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="935.562,319.46 935.812,339.32 936.076,359.177 936.365,379.025 936.694,398.86 937.076,418.679 937.523,438.478 938.049,458.252 938.667,477.997 939.39,497.71 940.231,517.385 941.204,537.02 942.322,556.609 943.597,576.148 945.043,595.635 946.673,615.064 948.5,634.431 950.537,653.732 952.797,672.964 955.295,692.122 958.042,711.201 961.051,730.199 964.337,749.11 967.912,767.931 971.789,786.657 975.981,805.284 980.487,823.814 985.296,842.249 990.394,860.593 995.768,878.851 1001.41,897.027 1007.29,915.125 1013.41,933.149 1019.76,951.103 1026.32,968.991 1033.07,986.818 1040.01,1004.59 1047.12,1022.3 1054.38,1039.97 1061.8,1057.59 1069.34,1075.17 1077,1092.71 1084.76,1110.22 1092.62,1127.71 1100.56,1145.16 1108.56,1162.6 1116.61,1180.02 1124.71,1197.43 1132.83,1214.82 1140.96,1232.22 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1141.84,1198.69 1140.96,1232.22 1114.67,1211.4 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1140.96,1232.22 1132.83,1214.82 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1144.86,1242.4 1153.25,1254.62 1161.65,1266.82 1170.06,1279 1178.49,1291.15 1186.96,1303.25 1195.46,1315.29 1204.02,1327.27 1212.62,1339.17 1221.29,1350.98 1230.04,1362.69 1238.86,1374.29 1247.76,1385.76 1256.76,1397.1 1265.87,1408.29 1275.08,1419.32 1284.41,1430.19 1293.87,1440.87 1303.46,1451.37 1313.2,1461.66 1323.08,1471.74 1333.12,1481.59 1343.33,1491.21 1353.71,1500.58 1364.27,1509.69 1375.01,1518.54 1385.95,1527.11 1397.07,1535.43 1408.36,1543.5 1419.82,1551.33 1431.43,1558.94 1443.2,1566.33 1455.1,1573.52 1467.14,1580.52 1479.31,1587.35 1491.59,1594 1503.99,1600.49 1516.48,1606.84 1529.07,1613.06 1541.75,1619.15 1554.51,1625.13 1567.33,1631 1580.22,1636.79 1593.17,1642.5 1606.16,1648.14 1619.19,1653.73 1632.26,1659.27 1645.34,1664.78 1658.45,1670.26 1671.56,1675.73 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1649.65,1650.33 1671.56,1675.73 1638.09,1678.02 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1671.56,1675.73 1658.45,1670.26 "></polyline>
<path clip-path="url(#clip352)" d="M331.22 567.322 L325.34 557.137 L313.58 557.137 L307.7 567.322 L313.58 577.506 L325.34 577.506 L331.22 567.322 L331.22 567.322  Z" fill="#009af9" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="331.22,567.322 325.34,557.137 313.58,557.137 307.7,567.322 313.58,577.506 325.34,577.506 331.22,567.322 "></polyline>
<path clip-path="url(#clip352)" d="M538.839 1488.89 L532.959 1478.71 L521.2 1478.71 L515.32 1488.89 L521.2 1499.07 L532.959 1499.07 L538.839 1488.89 L538.839 1488.89  Z" fill="#009af9" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="538.839,1488.89 532.959,1478.71 521.2,1478.71 515.32,1488.89 521.2,1499.07 532.959,1499.07 538.839,1488.89 "></polyline>
<path clip-path="url(#clip352)" d="M947.322 319.46 L941.442 309.276 L929.682 309.276 L923.803 319.46 L929.682 329.644 L941.442 329.644 L947.322 319.46 L947.322 319.46  Z" fill="#009af9" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="947.322,319.46 941.442,309.276 929.682,309.276 923.803,319.46 929.682,329.644 941.442,329.644 947.322,319.46 "></polyline>
<path clip-path="url(#clip352)" d="M1156.62 1242.4 L1150.74 1232.22 L1138.98 1232.22 L1133.1 1242.4 L1138.98 1252.59 L1150.74 1252.59 L1156.62 1242.4 L1156.62 1242.4  Z" fill="#009af9" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1156.62,1242.4 1150.74,1232.22 1138.98,1232.22 1133.1,1242.4 1138.98,1252.59 1150.74,1252.59 1156.62,1242.4 "></polyline>
<path clip-path="url(#clip352)" d="M1692.3 1680.54 L1686.42 1670.36 L1674.66 1670.36 L1668.78 1680.54 L1674.66 1690.72 L1686.42 1690.72 L1692.3 1680.54 L1692.3 1680.54  Z" fill="#009af9" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1692.3,1680.54 1686.42,1670.36 1674.66,1670.36 1668.78,1680.54 1674.66,1690.72 1686.42,1690.72 1692.3,1680.54 "></polyline>
<circle clip-path="url(#clip352)" style="fill:#009af9; stroke:none; fill-opacity:0" cx="319.46" cy="567.322" r="2"></circle>
<circle clip-path="url(#clip352)" style="fill:#009af9; stroke:none; fill-opacity:0" cx="527.079" cy="1488.89" r="2"></circle>
<circle clip-path="url(#clip352)" style="fill:#009af9; stroke:none; fill-opacity:0" cx="935.562" cy="319.46" r="2"></circle>
<circle clip-path="url(#clip352)" style="fill:#009af9; stroke:none; fill-opacity:0" cx="1144.86" cy="1242.4" r="2"></circle>
<circle clip-path="url(#clip352)" style="fill:#009af9; stroke:none; fill-opacity:0" cx="1680.54" cy="1680.54" r="2"></circle>
<path clip-path="url(#clip350)" d="M322.481 565.16 L320.137 568.314 L322.602 571.642 L321.347 571.642 L319.46 569.095 L317.574 571.642 L316.318 571.642 L318.835 568.25 L316.532 565.16 L317.788 565.16 L319.506 567.469 L321.225 565.16 L322.481 565.16 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M523.925 1486.73 L525.054 1486.73 L527.079 1492.17 L529.105 1486.73 L530.233 1486.73 L527.803 1493.21 L526.356 1493.21 L523.925 1486.73 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M931.213 317.299 L932.278 317.299 L933.609 322.356 L934.934 317.299 L936.19 317.299 L937.521 322.356 L938.846 317.299 L939.911 317.299 L938.216 323.78 L936.96 323.78 L935.565 318.468 L934.165 323.78 L932.909 323.78 L931.213 317.299 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1142.41 1240.24 L1147.47 1240.24 L1147.47 1241.22 L1143.46 1245.87 L1147.47 1245.87 L1147.47 1246.72 L1142.26 1246.72 L1142.26 1245.75 L1146.27 1241.09 L1142.41 1241.09 L1142.41 1240.24 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1682.67 1678.57 L1682.67 1679.58 Q1682.22 1679.34 1681.73 1679.23 Q1681.25 1679.11 1680.73 1679.11 Q1679.93 1679.11 1679.53 1679.36 Q1679.14 1679.6 1679.14 1680.09 Q1679.14 1680.46 1679.42 1680.67 Q1679.71 1680.88 1680.56 1681.07 L1680.93 1681.15 Q1682.06 1681.39 1682.54 1681.84 Q1683.02 1682.28 1683.02 1683.07 Q1683.02 1683.97 1682.3 1684.5 Q1681.59 1685.03 1680.34 1685.03 Q1679.82 1685.03 1679.25 1684.92 Q1678.69 1684.83 1678.06 1684.62 L1678.06 1683.52 Q1678.65 1683.83 1679.23 1683.99 Q1679.8 1684.14 1680.36 1684.14 Q1681.11 1684.14 1681.52 1683.88 Q1681.92 1683.62 1681.92 1683.15 Q1681.92 1682.72 1681.63 1682.49 Q1681.34 1682.26 1680.35 1682.04 L1679.98 1681.95 Q1678.99 1681.75 1678.55 1681.32 Q1678.11 1680.88 1678.11 1680.13 Q1678.11 1679.22 1678.76 1678.72 Q1679.41 1678.22 1680.6 1678.22 Q1681.19 1678.22 1681.71 1678.31 Q1682.23 1678.4 1682.67 1678.57 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path></svg>
</div>
</div>
<p>So, our goal was given the DAG provided by the <code>ges</code> method in the causal discovery <span class="citation" data-cites="chickering2003optimal">(<a href="#ref-chickering2003optimal" role="doc-biblioref">Chickering 2003</a>)</span>, generate equations that rules each of these causal relations, represented in the DAG as directed edges. The SCM is the union of the DAG and these causal equations, that is, the SCM is a tuple <span class="math inline">\((G, \mathbf{f})\)</span>, where <span class="math inline">\(G\)</span> is the DAG and <span class="math inline">\(\mathbf{f}\)</span> is the set of functions that generates the value of each variable given its parents.</p>
<p>Our solution for constructing the structural causal equations was to assume that the data was generated by a linear model, ie, the causal relations were linear. For the DAG provided in the code example we derive</p>
<p><span class="math display">\[ v = \mathcal{b}_v \]</span></p>
<p><span class="math display">\[ x = \mathcal{a}_{v \to x} v + \mathcal{b}_x \]</span></p>
<p><span class="math display">\[ w = \mathcal{a}_{x \to w} x + \mathcal{b}_w \]</span></p>
<p><span class="math display">\[ z = \mathcal{a}_{v \to z} v+ \mathcal{a}_{w \to z} w + \mathcal{b}_z \]</span></p>
<p><span class="math display">\[ s = \mathcal{a}_{z \to s} z + \mathcal{b}_s \]</span></p>
<p>and that’s the tricky thing, as we can see these causal equations are different than the ones that generated the data, but they are the ones that respect the causal system obtained from the obtained DAG. Here <span class="math inline">\(\mathcal{b}_i\)</span> and <span class="math inline">\(\mathcal{a}_{i \to j}\)</span> are the intercept term and the coefficient obtained from the linear regression, respectively. To correctly solve the linear regression respecting the dependencies of the causal graph, we use <code>topological_sort_by_dfs</code> from <code>Graphs.jl</code>.</p>
<p>Now, with the SCM structure in hand, we see that the representation could be a struct containing the DAG and the coefficients/intercepts of the causal equations, this maps exactly the tuple <span class="math inline">\((G, \mathbf{f})\)</span> that we defined. However, since we need these equations to be differentiable, we need to define a function that takes the SCM and returns the value of the variable given its parents and using just the coefficients and the DAG, lead to errors, because <code>AutoDiff</code> does not deal well with functions that are conditioned (<code>if</code> statements). So, we need to define a way to retrieve the system of causal equations in a smooth way and that’s where the <code>causal_effects</code> matrix comes to the rescue.</p>
<p>Let the factual vector of features be denoted as:</p>
<p><span class="math display">\[
\mathbf{x}_F =
\begin{bmatrix}
x_{F_1} \\
x_{F_2} \\
x_{F_3} \\
\vdots \\
x_{F_n}
\end{bmatrix}
\]</span></p>
<p>Let the <code>causal_effects</code> matrix be:</p>
<p><span class="math display">\[
\mathbf{C} =
\begin{bmatrix}
a_{11} &amp; a_{12} &amp; \cdots &amp; a_{1n} &amp; b_1 \\
a_{21} &amp; a_{22} &amp; \cdots &amp; a_{2n} &amp; b_2 \\
a_{31} &amp; a_{32} &amp; \cdots &amp; a_{3n} &amp; b_3 \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots \\
a_{n1} &amp; a_{n2} &amp; \cdots &amp; a_{nn} &amp; b_n \\
\end{bmatrix}
\]</span></p>
<p>Here, <span class="math inline">\(a_{ij}\)</span> represents the coefficient from the causal effect of <span class="math inline">\(x_{F_j}\)</span> on <span class="math inline">\(x_{F_i}\)</span>, and <span class="math inline">\(b_i\)</span> represents the intercept term for the variable <span class="math inline">\(x_{F_i}\)</span>.</p>
<p>The matrix multiplication of the <code>causal_effects</code> matrix with the factual vector (excluding the bias term) is given by:</p>
<p><span class="math display">\[
\mathbf{C}_{:, 1:n} \cdot \mathbf{x}_F =
\begin{bmatrix}
a_{11} &amp; a_{12} &amp; \cdots &amp; a_{1n} \\
a_{21} &amp; a_{22} &amp; \cdots &amp; a_{2n} \\
a_{31} &amp; a_{32} &amp; \cdots &amp; a_{3n} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
a_{n1} &amp; a_{n2} &amp; \cdots &amp; a_{nn}
\end{bmatrix}
\begin{bmatrix}
x_{F_1} \\
x_{F_2} \\
x_{F_3} \\
\vdots \\
x_{F_n}
\end{bmatrix}
\]</span></p>
<p>Finally, we add the bias term:</p>
<p><span class="math display">\[
\mathbf{x}_{SCF} = \mathbf{C}_{:, 1:n} \cdot \mathbf{x}_F +
\begin{bmatrix}
b_1 \\
b_2 \\
b_3 \\
\vdots \\
b_n
\end{bmatrix}
\]</span></p>
<p>In expanded form:</p>
<p><span class="math display">\[
\mathbf{x}_{SCF_i} = a_{i1} x_{F_1} + a_{i2} x_{F_2} + \cdots + a_{in} x_{F_n} + b_i, \quad \forall i = 1, 2, \dots, n
\]</span></p>
<p>This equation shows how each counterfactual variable <span class="math inline">\(x_{SCF_i}\)</span> is generated as a linear combination of the factual inputs <span class="math inline">\(x_{F_j}\)</span> based on the causal effects matrix, with an intercept term <span class="math inline">\(b_i\)</span> added for each variable.</p>
<p>One can note that the <code>orphan</code> nodes, that is, the nodes that do not have parents in the DAG, are going to be equal to the intercept term <span class="math inline">\(\mathcal{b}_\hat{o}\)</span>. The intuition behind this is that when we do the linear regression, variables that have no causal parents are just equal to the unconditional mean of the variable, i.e, we get <span class="math inline">\(x_{SCF_\hat{o}} = \mathbb{E}(x_\hat{o})\)</span>. Because of this, in some cases a better understanding of the regression is needed, so the residuals are also part of the SCM structure,</p>
<div id="4" class="cell" data-execution_count="0">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">struct</span> SCM</span>
<span id="cb3-2"><a href="#cb3-2"></a>    variables<span class="op">::</span><span class="dt">Vector{String}</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    coefficients<span class="op">::</span><span class="dt">Vector{Vector{Float64}}</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    residuals<span class="op">::</span><span class="dt">Vector{Vector{Float64}}</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    dag<span class="op">::</span><span class="dt">DiGraph</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    causal_effects<span class="op">::</span><span class="dt">Matrix{Float64}</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="counterfactualexplanations.jl" class="level3">
<h3 class="anchored" data-anchor-id="counterfactualexplanations.jl"><code>CounterfactualExplanations.jl</code></h3>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<!-- In conclusion, this project has successfully integrated causal reasoning into the CounterfactualExplanations.jl package, providing a valuable tool for generating counterfactual explanations that are not only interpretable but also actionable. -->
</section>
<section id="references" class="level1">



<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-chickering2003optimal" class="csl-entry" role="listitem">
Chickering, David Maxwell. 2003. <span>“Optimal Structure Identification with Greedy Search.”</span> <em>J. Mach. Learn. Res.</em> 3 (null): 507–54. <a href="https://doi.org/10.1162/153244303321897717">https://doi.org/10.1162/153244303321897717</a>.
</div>
<div id="ref-karimi2021algorithmic" class="csl-entry" role="listitem">
Karimi, Amir-Hossein, Bernhard Schölkopf, and Isabel Valera. 2021. <span>“Algorithmic Recourse: From Counterfactual Explanations to Interventions.”</span> In <em>Proceedings of the 2021 ACM Conference on Fairness, Accountability, and Transparency</em>, 353–62. FAccT ’21. New York, NY, USA: Association for Computing Machinery. <a href="https://doi.org/10.1145/3442188.3445899">https://doi.org/10.1145/3442188.3445899</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{altmeyer2024,
  author = {Altmeyer, Patrick and Luiz Franco, Jorge},
  title = {When {Causality} Meets {Recourse}},
  date = {2024-09-17},
  url = {https://www.taija.org/blog/posts/causal-recourse/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-altmeyer2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Altmeyer, Patrick, and Jorge Luiz Franco. 2024. <span>“When Causality
Meets Recourse.”</span> September 17, 2024. <a href="https://www.taija.org/blog/posts/causal-recourse/">https://www.taija.org/blog/posts/causal-recourse/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.taija\.org\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="pat-alt/pat-alt.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb4" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">---</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="an">title:</span><span class="co"> "When Causality meets Recourse"</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="an">subtitle:</span><span class="co"> "Counterfactual Explanations through Structural Causal Models"</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="an">date:</span><span class="co"> '2024-09-17'</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="an">description:</span><span class="co"> |</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">    This post introduces a new tool in CounterfactualExplanations.jl, enhancing the package with causal reasoning to generate counterfactual explanations.</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="an">author:</span><span class="co"> </span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">    - name: Jorge Luiz Franco </span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">      url: https://www.linkedin.com/in/jorgelwyz/</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="an">categories:</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">  - counterfactuals</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">  - explainable AI</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">  - causality</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">  - Julia</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="an">image:</span><span class="co"> www/intro.png</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="an">execute:</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co">  eval: true</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co">  echo: true</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="an">engine:</span><span class="co"> julia</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="an">julia:</span><span class="co"> </span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="co">  exeflags: ["--project=./"]</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="an">code-fold:</span><span class="co"> show</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co">---</span></span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="fu"># Introduction</span></span>
<span id="cb4-26"><a href="#cb4-26"></a></span>
<span id="cb4-27"><a href="#cb4-27"></a>In recent years, the need for interpretable and explainable AI has surged, particularly in high-stakes domains. Counterfactual explanations provide a means to understand how changes to input features could alter the outcomes of machine learning models. This blog post presents a new tool in the CounterfactualExplanations.jl package, developed during my JSoC (Julia Summer of Code) project, which incorporates causal reasoning into counterfactual generation.</span>
<span id="cb4-28"><a href="#cb4-28"></a></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="fu"># Project Overview</span></span>
<span id="cb4-30"><a href="#cb4-30"></a></span>
<span id="cb4-31"><a href="#cb4-31"></a>This project aimed to enhance the CounterfactualExplanations.jl package by infusing it with a robust mathematical foundation for minimal algorithmic recourse, based on the principles of causal reasoning <span class="co">[</span><span class="ot">@karimi2021algorithmic</span><span class="co">]</span>. </span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="fu">## Key Contributions</span></span>
<span id="cb4-34"><a href="#cb4-34"></a></span>
<span id="cb4-35"><a href="#cb4-35"></a>During the project, I contributed to two key repositories:</span>
<span id="cb4-36"><a href="#cb4-36"></a></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="ss">1. </span>**CounterfactualExplanations.jl**: Developed a new tool for generating counterfactual explanations using causal information. This allows users to create smarter perturbations rather than random adjustments, ultimately providing more meaningful insights.</span>
<span id="cb4-38"><a href="#cb4-38"></a></span>
<span id="cb4-39"><a href="#cb4-39"></a><span class="ss">2. </span>**CausalInference.jl**: Implemented a Structural Causal Model (SCM) structure that extracts information from data, laying the groundwork for the causal reasoning capabilities in CounterfactualExplanations.jl.</span>
<span id="cb4-40"><a href="#cb4-40"></a></span>
<span id="cb4-41"><a href="#cb4-41"></a>This was an amazing experience, not just experience contribute to two repositories simultaneously, but also to work with the mantainers of these repos. I learned a lot about the Julia language and the Julia community. This was possible because of the mentorship of Patrick Altmeyer (CounterfactualExplanations) and Moritz Schauer (CausalInference), who guided me throughout the project and are amazing researchers.</span>
<span id="cb4-42"><a href="#cb4-42"></a></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="fu">## The `MINTGenerator`</span></span>
<span id="cb4-44"><a href="#cb4-44"></a></span>
<span id="cb4-45"><a href="#cb4-45"></a>In this project, we developed the MINTGenerator, a counterfactual generator based on the Recourse through Minimal</span>
<span id="cb4-46"><a href="#cb4-46"></a>Intervention (MINT) method proposed by @karimi2021algorithmic.</span>
<span id="cb4-47"><a href="#cb4-47"></a></span>
<span id="cb4-48"><a href="#cb4-48"></a><span class="fu">## Description</span></span>
<span id="cb4-49"><a href="#cb4-49"></a></span>
<span id="cb4-50"><a href="#cb4-50"></a>The MINTGenerator incorporates causal reeasoning in algorithm recourse to achieve minimal interventions when generating a counterfactual explanation. In this sense, the main ideia is that just perturbating a black box model without taking into account the causal relations in the data can guide to misleading recommendations. Here we now shift to a perspective where every action/pertubation is an intervetion in the causal graph of the problem, thus the change is not made just in the intervened upon variable, but also in its childs in the causal structure. The generator utilizes a Structural Causal Model(SCM) to encode the variables in a way that causal effects are propagated and uses a generic gradient-based generator to create the search path, that is, any gradient-base generator (ECCo, REVISE, Watcher, ...) can be used with the MINT SCM encoder to generate counterfactual samples in latent space for minimal intervetions algorithm recourse.</span>
<span id="cb4-51"><a href="#cb4-51"></a></span>
<span id="cb4-52"><a href="#cb4-52"></a>The MINT algorithm minimizes a loss function that combines the causal constraints of the SCM and the distance between the generated counterfactual and the original input. Since we want a gradient-based generator, we need to pass the constrained optimizaiton problem into an unconstrained one and we do this by using the Lagrangian. Initially, as defined in <span class="co">[</span><span class="ot">@karimi2021algorithmic</span><span class="co">]</span>, we aim to aim to find the minimal cost set of actions $A$ (in the form of structural interventions) that results in a counterfactual instance yielding the favorable output from $h$,</span>
<span id="cb4-53"><a href="#cb4-53"></a></span>
<span id="cb4-54"><a href="#cb4-54"></a>$$</span>
<span id="cb4-55"><a href="#cb4-55"></a>\begin{aligned}</span>
<span id="cb4-56"><a href="#cb4-56"></a></span>
<span id="cb4-57"><a href="#cb4-57"></a>A^* \in \arg\min_A \text{cost}(A; \mathbf{x}_F)<span class="sc">\\</span></span>
<span id="cb4-58"><a href="#cb4-58"></a>\textrm{s.t.} \quad  h(\mathbf{x}_{SCF}) \neq h(\mathbf{x}_F) \; \; \text{,}<span class="sc">\\</span></span>
<span id="cb4-59"><a href="#cb4-59"></a></span>
<span id="cb4-60"><a href="#cb4-60"></a>\end{aligned} </span>
<span id="cb4-61"><a href="#cb4-61"></a>$$</span>
<span id="cb4-62"><a href="#cb4-62"></a></span>
<span id="cb4-63"><a href="#cb4-63"></a>where $\mathbf{x}_F$ is the original input, $\mathbf{x}_{SCF}$ is the counterfactual instance, and $h$ is the black-box model. We use the $\mathbf{x}_{SCF}$ terminology because the counterfactual is derived from the SCM,</span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a>$$</span>
<span id="cb4-66"><a href="#cb4-66"></a>x_{SCF_i} = </span>
<span id="cb4-67"><a href="#cb4-67"></a>\begin{cases}</span>
<span id="cb4-68"><a href="#cb4-68"></a>x_{F_i} + \delta_i, &amp; \text{if } i \in I <span class="sc">\\</span></span>
<span id="cb4-69"><a href="#cb4-69"></a>x_{F_i} + f_i(\text{pa}_{SCF_i}) - f_i(\text{pa}_{F_i}), &amp; \text{if } i \notin I  \; \; \text{,}</span>
<span id="cb4-70"><a href="#cb4-70"></a>\end{cases} </span>
<span id="cb4-71"><a href="#cb4-71"></a>$$</span>
<span id="cb4-72"><a href="#cb4-72"></a></span>
<span id="cb4-73"><a href="#cb4-73"></a>where $I$ is the set of intervened upon variables, $f_i$ is the function that generates the value of the variable $i$ given its parents, and $\text{pa}_{SCF_i}$ and $\text{pa}_{F_i}$ are the parents of the variable $i$ in the counterfactual and original instance, respectively. This closed formula for the decision variable $\mathbf{x}_{SCF}$ is what makes possible to use a gradient-based generator, since with it the lagrangian is differentiable,</span>
<span id="cb4-74"><a href="#cb4-74"></a></span>
<span id="cb4-75"><a href="#cb4-75"></a>$$</span>
<span id="cb4-76"><a href="#cb4-76"></a>\mathcal{L}(A ; \lambda) = \text{cost}(A; \mathbf{x}_F) + \lambda \left(h(\mathbf{x}_{SCF}) - h(\mathbf{x}_F) \right) \; \; \text{,}</span>
<span id="cb4-77"><a href="#cb4-77"></a>$$</span>
<span id="cb4-78"><a href="#cb4-78"></a></span>
<span id="cb4-79"><a href="#cb4-79"></a>or in simple terms and more standard, since $\lambda$ is constant,</span>
<span id="cb4-80"><a href="#cb4-80"></a></span>
<span id="cb4-81"><a href="#cb4-81"></a>$$</span>
<span id="cb4-82"><a href="#cb4-82"></a>\mathcal{L_{\texttt{MINT}}}(\mathbf{x}_{SCF}) = \lambda \text{cost}(\mathbf{x}_{SCF}; \mathbf{x}_F) + \text{yloss}(\mathbf{x}_{SCF},y^*) \; \; \text{,}</span>
<span id="cb4-83"><a href="#cb4-83"></a>$$</span>
<span id="cb4-84"><a href="#cb4-84"></a></span>
<span id="cb4-85"><a href="#cb4-85"></a>where $y^*$ is clearly $h(x_F)$ and $\text{yloss}$ is : </span>
<span id="cb4-86"><a href="#cb4-86"></a></span>
<span id="cb4-87"><a href="#cb4-87"></a>$$</span>
<span id="cb4-88"><a href="#cb4-88"></a>\text{yloss}(\mathbf{x}_{SCF}, y^*) = h \left(\left\{ x_{F_i} + \delta_i [i \in I] + \left(f_i(\text{pa}_{SCF_i}) - f_i(\text{pa}_{F_i}) \right) [i \notin I] \right\}_{i=1}^n \right) - y^* \; \; \text{.} </span>
<span id="cb4-89"><a href="#cb4-89"></a>$$</span>
<span id="cb4-90"><a href="#cb4-90"></a></span>
<span id="cb4-91"><a href="#cb4-91"></a><span class="fu">## Implementation</span></span>
<span id="cb4-92"><a href="#cb4-92"></a></span>
<span id="cb4-93"><a href="#cb4-93"></a><span class="fu">### `CausalInference.jl`</span></span>
<span id="cb4-94"><a href="#cb4-94"></a></span>
<span id="cb4-95"><a href="#cb4-95"></a>In terms of implementation, we need to capture the causal relations from the data, that's where <span class="in">`CausalInference.jl`</span> comes in. However, before the project, the package did not have a SCM structure, in the sense that the methods just captured the topological Directed Acyclic Graph (DAG) that showed the causality ruling the data, that is, no causal structural equations were provided,</span>
<span id="cb4-96"><a href="#cb4-96"></a></span>
<span id="cb4-99"><a href="#cb4-99"></a><span class="in">```{julia}</span></span>
<span id="cb4-100"><a href="#cb4-100"></a><span class="in">#| output: true</span></span>
<span id="cb4-101"><a href="#cb4-101"></a></span>
<span id="cb4-102"><a href="#cb4-102"></a><span class="in">using CausalInference</span></span>
<span id="cb4-103"><a href="#cb4-103"></a><span class="in">using Plots, GraphRecipes</span></span>
<span id="cb4-104"><a href="#cb4-104"></a><span class="in">using Random</span></span>
<span id="cb4-105"><a href="#cb4-105"></a><span class="in">Random.seed!(1)</span></span>
<span id="cb4-106"><a href="#cb4-106"></a></span>
<span id="cb4-107"><a href="#cb4-107"></a><span class="in">N = 2000 # number of data points</span></span>
<span id="cb4-108"><a href="#cb4-108"></a></span>
<span id="cb4-109"><a href="#cb4-109"></a><span class="in">x = randn(N)</span></span>
<span id="cb4-110"><a href="#cb4-110"></a><span class="in">v = x + randn(N)*0.25</span></span>
<span id="cb4-111"><a href="#cb4-111"></a><span class="in">w = x + randn(N)*0.25</span></span>
<span id="cb4-112"><a href="#cb4-112"></a><span class="in">z = v + w + randn(N)*0.25</span></span>
<span id="cb4-113"><a href="#cb4-113"></a><span class="in">s = z + randn(N)*0.25</span></span>
<span id="cb4-114"><a href="#cb4-114"></a></span>
<span id="cb4-115"><a href="#cb4-115"></a><span class="in">df = (x=x, v=v, w=w, z=z, s=s)</span></span>
<span id="cb4-116"><a href="#cb4-116"></a></span>
<span id="cb4-117"><a href="#cb4-117"></a><span class="in">est_g, score = ges(df; penalty=1.0, parallel=true)</span></span>
<span id="cb4-118"><a href="#cb4-118"></a></span>
<span id="cb4-119"><a href="#cb4-119"></a><span class="in">plt = graphplot(pdag2dag!(est_g), names= [String(k) for k in keys(df)], size=(500,500), nodesize=0.1, fontsize=2)</span></span>
<span id="cb4-120"><a href="#cb4-120"></a><span class="in">savefig(plt, "www/intro.png")</span></span>
<span id="cb4-121"><a href="#cb4-121"></a><span class="in">display(plt)</span></span>
<span id="cb4-122"><a href="#cb4-122"></a><span class="in">```</span></span>
<span id="cb4-123"><a href="#cb4-123"></a></span>
<span id="cb4-124"><a href="#cb4-124"></a>So, our goal was given the DAG provided by the <span class="in">`ges`</span> method in the causal discovery <span class="co">[</span><span class="ot">@chickering2003optimal</span><span class="co">]</span>, generate equations that rules each of these causal relations, represented in the DAG as directed edges. The SCM is the union of the DAG and these causal equations, that is, the SCM is a tuple $(G, \mathbf{f})$, where $G$ is the DAG and $\mathbf{f}$ is the set of functions that generates the value of each variable given its parents. </span>
<span id="cb4-125"><a href="#cb4-125"></a></span>
<span id="cb4-126"><a href="#cb4-126"></a>Our solution for constructing the structural causal equations was to assume that the data was generated by a linear model, ie, the causal relations were linear. For the DAG provided in the code example we derive</span>
<span id="cb4-127"><a href="#cb4-127"></a></span>
<span id="cb4-128"><a href="#cb4-128"></a>$$ v = \mathcal{b}_v $$</span>
<span id="cb4-129"><a href="#cb4-129"></a></span>
<span id="cb4-130"><a href="#cb4-130"></a>$$ x = \mathcal{a}_{v \to x} v + \mathcal{b}_x $$</span>
<span id="cb4-131"><a href="#cb4-131"></a></span>
<span id="cb4-132"><a href="#cb4-132"></a>$$ w = \mathcal{a}_{x \to w} x + \mathcal{b}_w $$</span>
<span id="cb4-133"><a href="#cb4-133"></a></span>
<span id="cb4-134"><a href="#cb4-134"></a>$$ z = \mathcal{a}_{v \to z} v+ \mathcal{a}_{w \to z} w + \mathcal{b}_z $$</span>
<span id="cb4-135"><a href="#cb4-135"></a></span>
<span id="cb4-136"><a href="#cb4-136"></a>$$ s = \mathcal{a}_{z \to s} z + \mathcal{b}_s $$</span>
<span id="cb4-137"><a href="#cb4-137"></a></span>
<span id="cb4-138"><a href="#cb4-138"></a>and that's the tricky thing, as we can see these causal equations are different than the ones that generated the data, but they are the ones that respect the causal system obtained from the obtained DAG. Here $\mathcal{b}_i$ and $\mathcal{a}_{i \to j}$ are the intercept term and the coefficient obtained from the linear regression, respectively. To correctly solve the linear regression respecting the dependencies of the causal graph, we use <span class="in">`topological_sort_by_dfs`</span> from <span class="in">`Graphs.jl`</span>.</span>
<span id="cb4-139"><a href="#cb4-139"></a></span>
<span id="cb4-140"><a href="#cb4-140"></a>Now, with the SCM structure in hand, we see that the representation could be a struct containing the DAG and the coefficients/intercepts of the causal equations, this maps exactly the tuple $(G, \mathbf{f})$ that we defined. However, since we need these equations to be differentiable, we need to define a function that takes the SCM and returns the value of the variable given its parents and using just the coefficients and the DAG, lead to errors, because <span class="in">`AutoDiff`</span> does not deal well with functions that are conditioned (<span class="in">`if`</span> statements). So, we need to define a way to retrieve the system of causal equations in a smooth way and that's where the <span class="in">`causal_effects`</span> matrix comes to the rescue.</span>
<span id="cb4-141"><a href="#cb4-141"></a></span>
<span id="cb4-142"><a href="#cb4-142"></a>Let the factual vector of features be denoted as:</span>
<span id="cb4-143"><a href="#cb4-143"></a></span>
<span id="cb4-144"><a href="#cb4-144"></a>$$</span>
<span id="cb4-145"><a href="#cb4-145"></a>\mathbf{x}_F = </span>
<span id="cb4-146"><a href="#cb4-146"></a>\begin{bmatrix}</span>
<span id="cb4-147"><a href="#cb4-147"></a>x_{F_1} <span class="sc">\\</span></span>
<span id="cb4-148"><a href="#cb4-148"></a>x_{F_2} <span class="sc">\\</span></span>
<span id="cb4-149"><a href="#cb4-149"></a>x_{F_3} <span class="sc">\\</span></span>
<span id="cb4-150"><a href="#cb4-150"></a>\vdots <span class="sc">\\</span></span>
<span id="cb4-151"><a href="#cb4-151"></a>x_{F_n}</span>
<span id="cb4-152"><a href="#cb4-152"></a>\end{bmatrix}</span>
<span id="cb4-153"><a href="#cb4-153"></a>$$</span>
<span id="cb4-154"><a href="#cb4-154"></a></span>
<span id="cb4-155"><a href="#cb4-155"></a>Let the <span class="in">`causal_effects`</span> matrix be:</span>
<span id="cb4-156"><a href="#cb4-156"></a></span>
<span id="cb4-157"><a href="#cb4-157"></a>$$</span>
<span id="cb4-158"><a href="#cb4-158"></a>\mathbf{C} =</span>
<span id="cb4-159"><a href="#cb4-159"></a>\begin{bmatrix}</span>
<span id="cb4-160"><a href="#cb4-160"></a>a_{11} &amp; a_{12} &amp; \cdots &amp; a_{1n} &amp; b_1 <span class="sc">\\</span></span>
<span id="cb4-161"><a href="#cb4-161"></a>a_{21} &amp; a_{22} &amp; \cdots &amp; a_{2n} &amp; b_2 <span class="sc">\\</span></span>
<span id="cb4-162"><a href="#cb4-162"></a>a_{31} &amp; a_{32} &amp; \cdots &amp; a_{3n} &amp; b_3 <span class="sc">\\</span></span>
<span id="cb4-163"><a href="#cb4-163"></a>\vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots <span class="sc">\\</span></span>
<span id="cb4-164"><a href="#cb4-164"></a>a_{n1} &amp; a_{n2} &amp; \cdots &amp; a_{nn} &amp; b_n <span class="sc">\\</span></span>
<span id="cb4-165"><a href="#cb4-165"></a>\end{bmatrix}</span>
<span id="cb4-166"><a href="#cb4-166"></a>$$</span>
<span id="cb4-167"><a href="#cb4-167"></a></span>
<span id="cb4-168"><a href="#cb4-168"></a>Here, $a_{ij}$ represents the coefficient from the causal effect of $x_{F_j}$ on $x_{F_i}$, and $b_i$ represents the intercept term for the variable $x_{F_i}$.</span>
<span id="cb4-169"><a href="#cb4-169"></a></span>
<span id="cb4-170"><a href="#cb4-170"></a>The matrix multiplication of the <span class="in">`causal_effects`</span> matrix with the factual vector (excluding the bias term) is given by:</span>
<span id="cb4-171"><a href="#cb4-171"></a></span>
<span id="cb4-172"><a href="#cb4-172"></a>$$</span>
<span id="cb4-173"><a href="#cb4-173"></a>\mathbf{C}_{:, 1:n} \cdot \mathbf{x}_F =</span>
<span id="cb4-174"><a href="#cb4-174"></a>\begin{bmatrix}</span>
<span id="cb4-175"><a href="#cb4-175"></a>a_{11} &amp; a_{12} &amp; \cdots &amp; a_{1n} <span class="sc">\\</span></span>
<span id="cb4-176"><a href="#cb4-176"></a>a_{21} &amp; a_{22} &amp; \cdots &amp; a_{2n} <span class="sc">\\</span></span>
<span id="cb4-177"><a href="#cb4-177"></a>a_{31} &amp; a_{32} &amp; \cdots &amp; a_{3n} <span class="sc">\\</span></span>
<span id="cb4-178"><a href="#cb4-178"></a>\vdots &amp; \vdots &amp; \ddots &amp; \vdots <span class="sc">\\</span></span>
<span id="cb4-179"><a href="#cb4-179"></a>a_{n1} &amp; a_{n2} &amp; \cdots &amp; a_{nn}</span>
<span id="cb4-180"><a href="#cb4-180"></a>\end{bmatrix}</span>
<span id="cb4-181"><a href="#cb4-181"></a>\begin{bmatrix}</span>
<span id="cb4-182"><a href="#cb4-182"></a>x_{F_1} <span class="sc">\\</span></span>
<span id="cb4-183"><a href="#cb4-183"></a>x_{F_2} <span class="sc">\\</span></span>
<span id="cb4-184"><a href="#cb4-184"></a>x_{F_3} <span class="sc">\\</span></span>
<span id="cb4-185"><a href="#cb4-185"></a>\vdots <span class="sc">\\</span></span>
<span id="cb4-186"><a href="#cb4-186"></a>x_{F_n}</span>
<span id="cb4-187"><a href="#cb4-187"></a>\end{bmatrix}</span>
<span id="cb4-188"><a href="#cb4-188"></a>$$</span>
<span id="cb4-189"><a href="#cb4-189"></a></span>
<span id="cb4-190"><a href="#cb4-190"></a>Finally, we add the bias term:</span>
<span id="cb4-191"><a href="#cb4-191"></a></span>
<span id="cb4-192"><a href="#cb4-192"></a>$$</span>
<span id="cb4-193"><a href="#cb4-193"></a>\mathbf{x}_{SCF} = \mathbf{C}_{:, 1:n} \cdot \mathbf{x}_F + </span>
<span id="cb4-194"><a href="#cb4-194"></a>\begin{bmatrix}</span>
<span id="cb4-195"><a href="#cb4-195"></a>b_1 <span class="sc">\\</span></span>
<span id="cb4-196"><a href="#cb4-196"></a>b_2 <span class="sc">\\</span></span>
<span id="cb4-197"><a href="#cb4-197"></a>b_3 <span class="sc">\\</span></span>
<span id="cb4-198"><a href="#cb4-198"></a>\vdots <span class="sc">\\</span></span>
<span id="cb4-199"><a href="#cb4-199"></a>b_n</span>
<span id="cb4-200"><a href="#cb4-200"></a>\end{bmatrix}</span>
<span id="cb4-201"><a href="#cb4-201"></a>$$</span>
<span id="cb4-202"><a href="#cb4-202"></a></span>
<span id="cb4-203"><a href="#cb4-203"></a>In expanded form:</span>
<span id="cb4-204"><a href="#cb4-204"></a></span>
<span id="cb4-205"><a href="#cb4-205"></a>$$</span>
<span id="cb4-206"><a href="#cb4-206"></a>\mathbf{x}_{SCF_i} = a_{i1} x_{F_1} + a_{i2} x_{F_2} + \cdots + a_{in} x_{F_n} + b_i, \quad \forall i = 1, 2, \dots, n</span>
<span id="cb4-207"><a href="#cb4-207"></a>$$</span>
<span id="cb4-208"><a href="#cb4-208"></a></span>
<span id="cb4-209"><a href="#cb4-209"></a>This equation shows how each counterfactual variable $x_{SCF_i}$ is generated as a linear combination of the factual inputs $x_{F_j}$ based on the causal effects matrix, with an intercept term $b_i$ added for each variable.</span>
<span id="cb4-210"><a href="#cb4-210"></a></span>
<span id="cb4-211"><a href="#cb4-211"></a>One can note that the <span class="in">`orphan`</span> nodes, that is, the nodes that do not have parents in the DAG, are going to be equal to the intercept term $\mathcal{b}_\hat{o}$. The intuition behind this is that when we do the linear regression, variables that have no causal parents are just equal to the unconditional mean of the variable, i.e, we get $x_{SCF_\hat{o}} = \mathbb{E}(x_\hat{o})$. Because of this, in some cases a better understanding of the regression is needed, so the residuals are also part of the SCM structure,</span>
<span id="cb4-212"><a href="#cb4-212"></a></span>
<span id="cb4-215"><a href="#cb4-215"></a><span class="in">```{julia}</span></span>
<span id="cb4-216"><a href="#cb4-216"></a><span class="in">#| eval: false</span></span>
<span id="cb4-217"><a href="#cb4-217"></a></span>
<span id="cb4-218"><a href="#cb4-218"></a><span class="in">struct SCM</span></span>
<span id="cb4-219"><a href="#cb4-219"></a><span class="in">    variables::Vector{String}</span></span>
<span id="cb4-220"><a href="#cb4-220"></a><span class="in">    coefficients::Vector{Vector{Float64}}</span></span>
<span id="cb4-221"><a href="#cb4-221"></a><span class="in">    residuals::Vector{Vector{Float64}}</span></span>
<span id="cb4-222"><a href="#cb4-222"></a><span class="in">    dag::DiGraph</span></span>
<span id="cb4-223"><a href="#cb4-223"></a><span class="in">    causal_effects::Matrix{Float64}</span></span>
<span id="cb4-224"><a href="#cb4-224"></a><span class="in">end</span></span>
<span id="cb4-225"><a href="#cb4-225"></a><span class="in">```</span></span>
<span id="cb4-226"><a href="#cb4-226"></a></span>
<span id="cb4-227"><a href="#cb4-227"></a><span class="fu">### `CounterfactualExplanations.jl` </span></span>
<span id="cb4-228"><a href="#cb4-228"></a></span>
<span id="cb4-229"><a href="#cb4-229"></a></span>
<span id="cb4-230"><a href="#cb4-230"></a><span class="fu"># Conclusion</span></span>
<span id="cb4-231"><a href="#cb4-231"></a></span>
<span id="cb4-232"><a href="#cb4-232"></a><span class="co">&lt;!-- In conclusion, this project has successfully integrated causal reasoning into the CounterfactualExplanations.jl package, providing a valuable tool for generating counterfactual explanations that are not only interpretable but also actionable. --&gt;</span></span>
<span id="cb4-233"><a href="#cb4-233"></a></span>
<span id="cb4-234"><a href="#cb4-234"></a><span class="fu"># References</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" class="img-fluid" alt="License: MIT"></a> <a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg" class="img-fluid" alt="CC BY 4.0"></a> © 2024, Taija</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/JuliaTrustworthyAI/.github/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.taija.org/">
      <i class="bi bi-house" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JuliaTrustworthyAI">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>